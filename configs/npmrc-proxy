#!/bin/bash
# npm 代理配置（on/off）
set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
PROXY_URL="$(get_proxy_url)"

usage() {
  cat <<'EOF'
用法: npmrc-proxy <on|off>
说明: 按 setproxy 的地址开启/关闭 npm 代理。
EOF
}

log() { echo "[npm] $*"; }

require_npm() {
  command -v npm >/dev/null 2>&1 || {
    log "未找到 npm 命令，请先安装 Node/npm"
    exit 1
  }
}

show_config() {
  log "HTTP proxy: $(npm config get proxy 2>/dev/null || echo unset)"
  log "HTTPS proxy: $(npm config get https-proxy 2>/dev/null || echo unset)"
  log "Registry: $(npm config get registry 2>/dev/null || echo unset)"
}

cmd="${1:-}"

case "$cmd" in
  on)
    require_npm
    log "设置 npm 代理 -> $PROXY_URL"
    npm config set proxy "$PROXY_URL"
    npm config set https-proxy "$PROXY_URL"
    npm config set registry https://registry.npmjs.org/
    show_config
    ;;
  off)
    require_npm
    log "清理 npm 代理"
    npm config delete proxy >/dev/null 2>&1 || true
    npm config delete https-proxy >/dev/null 2>&1 || true
    show_config
    ;;
  *)
    usage
    exit 1
    ;;
esac
