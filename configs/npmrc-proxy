#!/bin/bash
# npm 代理配置（on/off）
set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
PROXY_URL="$(get_proxy_url)"

usage() {
  cat <<'EOF'
用法: npmrc-proxy <on|off>
说明: 按 setproxy 的地址开启/关闭 npm 代理。
EOF
}

log() { echo "[npm] $*"; }

require_npm() {
  command -v npm >/dev/null 2>&1 || {
    log "未找到 npm 命令，请先安装 Node/npm"
    exit 1
  }
}

show_config() {
  local scopes=("user" "global")
  for scope in "${scopes[@]}"; do
    log "[$scope] HTTP proxy: $(npm config get proxy --location=$scope 2>/dev/null || echo unset)"
    log "[$scope] HTTPS proxy: $(npm config get https-proxy --location=$scope 2>/dev/null || echo unset)"
    log "[$scope] Registry: $(npm config get registry --location=$scope 2>/dev/null || echo unset)"
  done
}

cmd="${1:-}"

case "$cmd" in
  on)
    require_npm
    log "设置 npm 代理 -> $PROXY_URL"
    npm config set proxy "$PROXY_URL" --location=user
    npm config set https-proxy "$PROXY_URL" --location=user
    npm config set registry https://registry.npmjs.org/ --location=user
    show_config
    ;;
  off)
    require_npm
    log "清理 npm 代理"
    for scope in user global; do
      npm config delete proxy --location="$scope" >/dev/null 2>&1 || true
      npm config delete https-proxy --location="$scope" >/dev/null 2>&1 || true
      npm config delete registry --location="$scope" >/dev/null 2>&1 || true
    done
    show_config
    ;;
  *)
    usage
    exit 1
    ;;
esac
