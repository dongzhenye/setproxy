# macOS ç»ˆç«¯ä»£ç†é…ç½®
# å°†æ­¤å†…å®¹æ·»åŠ åˆ° ~/.zshrc æ–‡ä»¶ä¸­

# èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$HOME/.setproxy"

# åŠ è½½é€šç”¨å‡½æ•°
if [ -f "$SCRIPT_DIR/common.sh" ]; then
    source "$SCRIPT_DIR/common.sh"
elif [ -f "$HOME/.setproxy/common.sh" ]; then
    source "$HOME/.setproxy/common.sh"
else
    # åŽå¤‡æ–¹æ¡ˆï¼šå¦‚æžœæ‰¾ä¸åˆ° common.shï¼Œä½¿ç”¨å†…è”å‡½æ•°
    get_proxy_url() {
        local port="7890"
        [ -n "$SETPROXY_PORT" ] && port="$SETPROXY_PORT"
        echo "http://127.0.0.1:$port"
    }
fi

# èŽ·å–ä»£ç†URL
PROXY_URL="$(get_proxy_url)"

# ä»£ç†å¿«æ·å‘½ä»¤
proxy-on() {
    local proxy_url="$(get_proxy_url)"
    export HTTP_PROXY="$proxy_url"
    export HTTPS_PROXY="$proxy_url"
    export ALL_PROXY="$proxy_url"
    export http_proxy="$proxy_url"
    export https_proxy="$proxy_url"
    export all_proxy="$proxy_url"
    export NO_PROXY="localhost,127.0.0.1,::1,192.168.0.0/16,10.0.0.0/8,172.16.0.0/12,100.64.0.0/10,17.0.0.0/8,169.254.0.0/16,224.0.0.0/4,240.0.0.0/4"
    export no_proxy="${NO_PROXY}"
    echo "âœ… ä»£ç†å·²å¼€å¯ - $proxy_url"
}

proxy-off() {
    unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy NO_PROXY no_proxy
    echo "ðŸ”´ ä»£ç†å·²å…³é—­"
}

proxy-status() {
    echo "HTTP_PROXY: ${HTTP_PROXY:-æœªè®¾ç½®}"
    echo "HTTPS_PROXY: ${HTTPS_PROXY:-æœªè®¾ç½®}"
    echo "ALL_PROXY: ${ALL_PROXY:-æœªè®¾ç½®}"
}

# æ£€æŸ¥ä»£ç†è¿žæŽ¥çš„å‡½æ•°
proxy-test() {
    echo "ðŸ” å¼€å§‹ä»£ç†æµ‹è¯•..."
    echo ""
    
    # æ£€æŸ¥curlæ˜¯å¦å¯ç”¨
    if ! command -v curl > /dev/null; then
        echo "âŒ curlå‘½ä»¤ä¸å¯ç”¨ï¼Œæ— æ³•è¿›è¡Œæµ‹è¯•"
        return 1
    fi
    
    # 1. æ£€æŸ¥IPåœ°å€å’Œä½ç½®
    echo "ðŸ“ IPåœ°å€æ£€æµ‹:"
    echo "-------------------"
    
    # å°è¯•å¤šä¸ªIPæ£€æµ‹æœåŠ¡ï¼Œç¡®ä¿å¯é æ€§
    local ip_info=""
    local service_used=""
    
    # é¦–é€‰ ipinfo.io (è¿”å›žJSONæ ¼å¼ï¼ŒåŒ…å«å›½å®¶ä¿¡æ¯)
    ip_info=$(curl -s --connect-timeout 5 --max-time 10 https://ipinfo.io 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$ip_info" ]; then
        service_used="ipinfo.io"
        local ip=$(echo "$ip_info" | grep -o '"ip": *"[^"]*"' | cut -d'"' -f4)
        local city=$(echo "$ip_info" | grep -o '"city": *"[^"]*"' | cut -d'"' -f4)
        local region=$(echo "$ip_info" | grep -o '"region": *"[^"]*"' | cut -d'"' -f4)
        local country=$(echo "$ip_info" | grep -o '"country": *"[^"]*"' | cut -d'"' -f4)
        local org=$(echo "$ip_info" | grep -o '"org": *"[^"]*"' | cut -d'"' -f4)
        
        echo "  IPåœ°å€: $ip"
        echo "  ä½ç½®: $city, $region, $country"
        echo "  è¿è¥å•†: $org"
    else
        # å¤‡é€‰æ–¹æ¡ˆ1: ifconfig.me (ç®€å•ä½†å¯é )
        local ip=$(curl -s --connect-timeout 5 --max-time 10 https://ifconfig.me 2>/dev/null)
        if [ $? -eq 0 ] && [ -n "$ip" ]; then
            service_used="ifconfig.me"
            echo "  IPåœ°å€: $ip"
            # å°è¯•èŽ·å–å›½å®¶ä¿¡æ¯
            local country=$(curl -s --connect-timeout 5 --max-time 10 https://ifconfig.me/country 2>/dev/null)
            if [ -n "$country" ]; then
                echo "  å›½å®¶: $country"
            fi
        else
            # å¤‡é€‰æ–¹æ¡ˆ2: icanhazip.com
            local ip=$(curl -s --connect-timeout 5 --max-time 10 https://icanhazip.com 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$ip" ]; then
                service_used="icanhazip.com"
                echo "  IPåœ°å€: $ip"
            else
                echo "  âŒ æ— æ³•èŽ·å–IPåœ°å€ä¿¡æ¯"
            fi
        fi
    fi
    
    if [ -n "$service_used" ]; then
        echo "  æ•°æ®æ¥æº: $service_used"
    fi
    
    echo ""
    
    # 2. æµ‹è¯•ä»£ç†è¿žæŽ¥
    echo "ðŸŒ è¿žæŽ¥æµ‹è¯•:"
    echo "-------------------"
    
    # æµ‹è¯•Google
    echo -n "  Google: "
    local google_result=$(curl -s -I --connect-timeout 5 --max-time 10 -w "\n%{http_code}" https://google.com 2>&1)
    local http_code=$(echo "$google_result" | tail -n1)
    if [[ "$http_code" =~ ^[23][0-9][0-9]$ ]]; then
        echo "âœ… è¿žæŽ¥æˆåŠŸ"
    else
        echo "âŒ è¿žæŽ¥å¤±è´¥"
        if [ -n "$HTTP_PROXY" ] && ! lsof -i :$(echo "$HTTP_PROXY" | grep -o '[0-9]*$') > /dev/null 2>&1; then
            echo "     â””â”€ æç¤º: ä»£ç†ç«¯å£æœªç›‘å¬ï¼Œè¯·æ£€æŸ¥ä»£ç†è½¯ä»¶"
        elif [[ "$google_result" =~ "SSL_ERROR" ]] || [[ "$google_result" =~ "SSL_connect" ]]; then
            echo "     â””â”€ æç¤º: SSLè¿žæŽ¥é”™è¯¯ï¼Œå¯èƒ½æ˜¯ä»£ç†é…ç½®é—®é¢˜"
        fi
    fi
    
    # æµ‹è¯•GitHub
    echo -n "  GitHub: "
    local github_result=$(curl -s -I --connect-timeout 5 --max-time 10 -w "\n%{http_code}" https://github.com 2>&1)
    local http_code=$(echo "$github_result" | tail -n1)
    if [[ "$http_code" =~ ^[23][0-9][0-9]$ ]]; then
        echo "âœ… è¿žæŽ¥æˆåŠŸ"
    else
        echo "âŒ è¿žæŽ¥å¤±è´¥"
    fi
    
    # æµ‹è¯•YouTube (é€šå¸¸éœ€è¦ä»£ç†)
    echo -n "  YouTube: "
    local youtube_result=$(curl -s -I --connect-timeout 5 --max-time 10 -w "\n%{http_code}" https://youtube.com 2>&1)
    local http_code=$(echo "$youtube_result" | tail -n1)
    if [[ "$http_code" =~ ^[23][0-9][0-9]$ ]]; then
        echo "âœ… è¿žæŽ¥æˆåŠŸ"
    else
        echo "âŒ è¿žæŽ¥å¤±è´¥"
        if [ -z "$HTTP_PROXY" ]; then
            echo "     â””â”€ æç¤º: YouTubeé€šå¸¸éœ€è¦ä»£ç†æ‰èƒ½è®¿é—®"
        fi
    fi
    
    echo ""
    
    # 3. ä»£ç†çŠ¶æ€æ€»ç»“
    echo "ðŸ“Š ä»£ç†çŠ¶æ€:"
    echo "-------------------"
    if [ -n "$HTTP_PROXY" ]; then
        echo "  âœ… ä»£ç†å·²å¯ç”¨: $HTTP_PROXY"
        # æ£€æŸ¥ä»£ç†ç«¯å£æ˜¯å¦åœ¨ç›‘å¬
        local proxy_port=$(echo "$HTTP_PROXY" | grep -o ':[0-9]*' | tr -d ':')
        if [ -z "$proxy_port" ]; then
            # å¦‚æžœæ— æ³•ä»Ž HTTP_PROXY æå–ç«¯å£ï¼Œä½¿ç”¨é…ç½®çš„ç«¯å£
            proxy_port=$(get_proxy_url | grep -o ':[0-9]*' | tr -d ':')
        fi
        if lsof -i :${proxy_port} > /dev/null 2>&1; then
            echo "  âœ… ä»£ç†æœåŠ¡è¿è¡Œæ­£å¸¸ (ç«¯å£ $proxy_port)"
        else
            echo "  âš ï¸  ä»£ç†ç«¯å£ $proxy_port æœªç›‘å¬ï¼Œè¯·æ£€æŸ¥ä»£ç†è½¯ä»¶"
        fi
    else
        echo "  âš ï¸  ä»£ç†æœªå¯ç”¨ (ä½¿ç”¨ proxy-on å¼€å¯)"
    fi
    
    echo ""
}

# å…¼å®¹ä¸‹åˆ’çº¿å†™æ³•ï¼ˆæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼‰
alias proxy_on=proxy-on
alias proxy_off=proxy-off
alias proxy_status=proxy-status
alias proxy_test=proxy-test

# æ™ºèƒ½ä»£ç†ï¼šæ£€æŸ¥ä»£ç†æœåŠ¡æ˜¯å¦è¿è¡Œï¼Œå¦‚æžœè¿è¡Œåˆ™è‡ªåŠ¨å¼€å¯ä»£ç†
# å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„è¡Œæ¥å¯ç”¨è‡ªåŠ¨ä»£ç†
# proxy_port=$(get_proxy_url | grep -o ':[0-9]*' | tr -d ':')
# if lsof -i :${proxy_port} > /dev/null 2>&1; then
#     proxy-on > /dev/null 2>&1
# fi 