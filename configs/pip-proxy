#!/bin/bash
# pip 代理配置（on/off）
set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
PROXY_URL="$(get_proxy_url)"
PIP_CONFIG_DIR="$HOME/.pip"
PIP_CONFIG_FILE="$PIP_CONFIG_DIR/pip.conf"

usage() {
  cat <<'EOF'
用法: pip-proxy <on|off>
说明: 按 setproxy 的地址写入/清理 ~/.pip/pip.conf。
EOF
}

log() { echo "[pip] $*"; }

show_config() {
  if [ -f "$PIP_CONFIG_FILE" ]; then
    local proxy_line
    proxy_line="$(grep '^proxy' "$PIP_CONFIG_FILE" 2>/dev/null | head -n1 | sed 's/^proxy = //')"
    log "配置文件: $PIP_CONFIG_FILE"
    log "proxy: ${proxy_line:-unset}"
  else
    log "配置文件: 未找到 ($PIP_CONFIG_FILE)"
  fi
}

cmd="${1:-}"

case "$cmd" in
  on)
    log "写入 pip 配置 -> $PROXY_URL"
    mkdir -p "$PIP_CONFIG_DIR"
    cat > "$PIP_CONFIG_FILE" <<EOF
[global]
proxy = $PROXY_URL
trusted-host = pypi.org
               files.pythonhosted.org
               pypi.python.org
EOF
    show_config
    ;;
  off)
    if [ -f "$PIP_CONFIG_FILE" ]; then
      log "移除 pip 配置 $PIP_CONFIG_FILE"
      rm -f "$PIP_CONFIG_FILE"
    else
      log "未找到配置文件，无需移除"
    fi
    show_config
    ;;
  *)
    usage
    exit 1
    ;;
esac
