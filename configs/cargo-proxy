#!/bin/bash
# Cargo 代理配置（on/off）
set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
PROXY_URL="$(get_proxy_url)"
CARGO_CONFIG_DIR="$HOME/.cargo"
CARGO_CONFIG_FILE="$CARGO_CONFIG_DIR/config.toml"

usage() {
  cat <<'EOF'
用法: cargo-proxy <on|off>
说明: 按 setproxy 的地址写入/清理 ~/.cargo/config.toml 中的代理配置。
EOF
}

log() { echo "[cargo] $*"; }

ensure_dir() {
  mkdir -p "$CARGO_CONFIG_DIR"
}

backup_config() {
  [ -f "$CARGO_CONFIG_FILE" ] || return 0
  local ts
  ts="$(date +%Y%m%d%H%M%S)"
  cp "$CARGO_CONFIG_FILE" "$CARGO_CONFIG_FILE.backup.$ts"
  log "已备份: $CARGO_CONFIG_FILE.backup.$ts"
}

append_proxy_block() {
  cat >> "$CARGO_CONFIG_FILE" <<EOF

[http]
proxy = "$PROXY_URL"

[https]
proxy = "$PROXY_URL"
EOF
}

remove_proxy_block() {
  [ -f "$CARGO_CONFIG_FILE" ] || { log "未找到 $CARGO_CONFIG_FILE，无需移除"; return; }
  python3 - "$CARGO_CONFIG_FILE" <<'PY'
import sys, pathlib, re
path = pathlib.Path(sys.argv[1])
data = path.read_text()
patterns = [
    r"\n*\[http\][^\[]*?(?=\n\[|$)",
    r"\n*\[https\][^\[]*?(?=\n\[|$)",
]
for pat in patterns:
    data = re.sub(pat, "\n", data, flags=re.S)
clean = data.strip()
path.write_text((clean + "\n") if clean else "")
PY
}

show_config() {
  if [ -f "$CARGO_CONFIG_FILE" ]; then
    local http_proxy https_proxy proxy_info
    proxy_info="$(python3 - "$CARGO_CONFIG_FILE" <<'PY'
import sys, pathlib, re
path = pathlib.Path(sys.argv[1])
data = path.read_text()
def find_proxy(section):
    pattern = rf"\[{section}\][^\[]*?proxy\s*=\s*['\"]?([^\s'\"]+)"
    m = re.search(pattern, data, re.I)
    return m.group(1) if m else "unset"
print(find_proxy("http"))
print(find_proxy("https"))
PY
)"
    http_proxy="$(echo "$proxy_info" | sed -n '1p')"
    https_proxy="$(echo "$proxy_info" | sed -n '2p')"
    log "配置文件: $CARGO_CONFIG_FILE"
    log "http.proxy: ${http_proxy:-unset}"
    log "https.proxy: ${https_proxy:-unset}"
  else
    log "配置文件: 未找到 ($CARGO_CONFIG_FILE)"
  fi
}

cmd="${1:-}"

case "$cmd" in
  on)
    ensure_dir
    backup_config
    log "设置 Cargo 代理 -> $PROXY_URL"
    append_proxy_block
    show_config
    ;;
  off)
    log "清理 Cargo 代理配置"
    remove_proxy_block
    show_config
    ;;
  *)
    usage
    exit 1
    ;;
esac
