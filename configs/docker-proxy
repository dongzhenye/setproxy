#!/bin/bash
# Docker ä»£ç†é…ç½®è„šæœ¬

PROXY_URL="http://127.0.0.1:7890"
DOCKER_CONFIG_DIR="$HOME/.docker"
DOCKER_CONFIG_FILE="$DOCKER_CONFIG_DIR/config.json"

if [ "$1" = "on" ]; then
    echo "ğŸ³ é…ç½®Dockerä»£ç†..."
    
    # åˆ›å»º .docker ç›®å½•
    mkdir -p "$DOCKER_CONFIG_DIR"
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®æ–‡ä»¶
    if [ -f "$DOCKER_CONFIG_FILE" ]; then
        # å¤‡ä»½åŸæ–‡ä»¶
        cp "$DOCKER_CONFIG_FILE" "$DOCKER_CONFIG_FILE.backup.$(date +%Y%m%d%H%M%S)"
        
        # ä½¿ç”¨ Python æ¥å®‰å…¨åœ°æ›´æ–° JSON
        python3 -c "
import json
import sys

with open('$DOCKER_CONFIG_FILE', 'r') as f:
    config = json.load(f)

config['proxies'] = {
    'default': {
        'httpProxy': '$PROXY_URL',
        'httpsProxy': '$PROXY_URL',
        'noProxy': 'localhost,127.0.0.1'
    }
}

with open('$DOCKER_CONFIG_FILE', 'w') as f:
    json.dump(config, f, indent=2)
" 2>/dev/null || {
            echo "âš ï¸  æ— æ³•æ›´æ–°Dockeré…ç½®ï¼Œè¯·æ‰‹åŠ¨é…ç½®"
            exit 1
        }
    else
        # åˆ›å»ºæ–°é…ç½®
        cat > "$DOCKER_CONFIG_FILE" << EOF
{
  "proxies": {
    "default": {
      "httpProxy": "$PROXY_URL",
      "httpsProxy": "$PROXY_URL",
      "noProxy": "localhost,127.0.0.1"
    }
  }
}
EOF
    fi
    
    echo "âœ… Dockerä»£ç†å·²å¼€å¯"
    echo "é…ç½®æ–‡ä»¶: $DOCKER_CONFIG_FILE"
    
elif [ "$1" = "off" ]; then
    echo "ğŸ³ å…³é—­Dockerä»£ç†..."
    
    if [ -f "$DOCKER_CONFIG_FILE" ]; then
        # ä½¿ç”¨ Python ç§»é™¤ä»£ç†é…ç½®
        python3 -c "
import json

with open('$DOCKER_CONFIG_FILE', 'r') as f:
    config = json.load(f)

if 'proxies' in config:
    del config['proxies']

with open('$DOCKER_CONFIG_FILE', 'w') as f:
    json.dump(config, f, indent=2)
" 2>/dev/null || echo "âš ï¸  æ— æ³•æ›´æ–°Dockeré…ç½®"
    fi
    
    echo "âœ… Dockerä»£ç†å·²å…³é—­"
else
    echo "ç”¨æ³•: $0 [on|off]"
    exit 1
fi